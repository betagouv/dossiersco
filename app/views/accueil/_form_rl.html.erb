<h2 class="separation"><%= t('.titre_responsable_legal') %></h2>


<div class="informations-rl mb-2" data-rl-id="<%= responsable&.id %>">
  <ul class="list-unstyled">
    <li><b><%= t('.lien_de_parente') %></b> : <%= responsable&.lien_de_parente %></li>
    <li><b><%= t('.prenom') %></b> : <%= responsable&.prenom %></li>
    <li><b><%= t('.nom') %></b> : <%= responsable&.nom %></li>
    <li><b><%= t('.adresse') %></b> : <%= responsable&.adresse %></li>
    <li><b><%= t('.code_postal') %></b> : <%= responsable&.code_postal %></li>
    <li><b><%= t('.ville') %></b> : <%= responsable&.ville&.upcase %></li>
    <li><b><%= t('.pays') %></b> :
      <% @liste_pays.each do |option| %>
        <%= option[0] if option[1] == responsable&.pays %>
      <% end %></li>
    <li><b><%= t('.telephone_principal') %></b> : <%= responsable&.tel_personnel %></li>
    <li><b><%= t('.telephone_secondaire') %></b> : <%= responsable&.tel_portable %></li>
    <li><b><%= t('.telephone_professionnel') %></b> : <%= responsable&.tel_professionnel %></li>
    <li><b><%= t('.email_principal') %></b> : <%= responsable&.email %></li>
  </ul>
  <a class="modifier-informations-rl button-outline primary" tabindex="0" data-rl-id="<%= responsable&.id %>" data-rl="<%= rl %>">
    <%= t('.modifier_informations') %>
  </a>
</div>

<div class="formulaire-rl mb-2" data-rl-id="<%= responsable&.id %>" style="display: none;">
  <div class="form__group">
    <%= f.label :lien_de_parente, t('.lien_de_parente') %>
    <%= f.select :lien_de_parente, options_for_select(@lien_de_parentes, :lien_de_parente) %>
  </div>

  <div class="form__group">
    <%= f.label :prenom, t('.prenom') %>
    <%= f.text_field :prenom, placeholder: "Prénom" %>
  </div>

  <div class="form__group">
    <%= f.label :nom, t('.nom') %>
    <%= f.text_field :nom, placeholder: "Nom" %>
  </div>

  <div class="form__group">
    <%= f.label :adresse, t('.adresse') %>
    <%= f.text_area :adresse, placeholder: "Numéro et nom de voie", rows: "3" %>
  </div>

  <div class="form__group" id="champs-code-postal-<%= rl %>">
    <%= f.label :code_postal, t('.code_postal') %>
    <%= f.number_field :code_postal, placeholder: t('.code_postal') %>
  </div>

  <div class="form__group" id="champs-select-ville-<%= rl %>">
    <% ville_rl = responsable&.ville ? responsable&.ville.upcase : '' %>
    <%= f.label :ville, t('.ville') %>
    <%= f.select :ville, options_for_select([ville_rl], :ville)%>
  </div>

  <div class="form__group" id="champs-text-ville-<%= rl %>" style="display: none;">
    <%= f.label :ville_etranger, t('.ville') %>
    <%= f.text_field :ville_etranger, placeholder: "Nom" %>
  </div>

  <div class="form__group">
    <%= f.label :pays, t('.pays') %>
    <%= f.select :pays, options_from_collection_for_select(@liste_pays, :last, :first, responsable.pays), data: {"resp-legal" => responsable.priorite}%>
    <!--    <label for="pays_<%#= rl %>"><%#= t('.pays') %></label>-->
    <!--    <select id="pays_<%#= rl %>" name="pays_<%#= rl %>" class="pays" data-resp-legal="1">-->
    <%# selected = responsable&.pays || "FRA" %>
    <%# @liste_pays.each do |option| %>
    <!--        <option value="<%#= option[1] %>" <%# if option[1] == selected %> selected <%# end %>><%#= option[0] %></option>-->
    <%# end %>
    <!--    </select>-->
  </div>

  <div class="form__group">
    <%= f.label :tel_personnel, t('.telephone_principal') %>
    <%= f.telephone_field :tel_personnel, placeholder: "Numéro de téléphone" %>
  </div>

  <div class="form__group">
    <%= f.label :tel_portable, t('.telephone_secondaire') %>
    <%= f.telephone_field :tel_portable, placeholder: "Numéro de téléphone" %>
  </div>

  <div class="form__group">
    <%= f.label :tel_professionnel, t('.telephone_professionnel') %>
    <%= f.telephone_field :tel_professionnel, placeholder: "Numéro de téléphone" %>
  </div>

  <div class="form__group">
    <%= f.label :email, t('.email_principal') %>
    <%= f.email_field :email, placeholder: "Numéro de téléphone" %>
  </div>
</div>

<div class="form__group">
  <% professions = @code_profession.map{ |k, v| v } %>
  <%= f.label :profession, t('.profession') %>
  <%= f.select :profession, options_for_select(professions, :profession) %>
</div>

<div class="form__group">
  <%= f.label :enfants_a_charge, t('.nb_total_enfants_a_charge') %>
  <%= f.number_field :enfants_a_charge %>
</div>

<div class="form__group">
  <%= label_tag do %>
    <%= t('.j_accepte') %>
    <%= f.radio_button :communique_info_parents_eleves, true %>
  <% end %>
  <%= label_tag do %>
    <%= t('.j_accepte_pas') %>
    <%= f.radio_button :communique_info_parents_eleves, false %>
  <% end %>
  <%= f.label :communique_info_parents_eleves, t('.coordonnees_communiquees') %>
</div>

<script type="text/javascript" charset="utf-8">
  $(document).ready(function () {
    const $button_rl = $('.modifier-informations-rl')
    $button_rl.click(function () {
      affiche_formulaire($(this))
    })
    $button_rl.on('keypress',function(e) {
      if(e.which === 13) {
        affiche_formulaire($(this))
      }
    });
    function affiche_formulaire($this) {
      let responsable_id = $this.data('rl-id')
      let numero_responsable = $this.data('rl')
      $(".informations-rl[data-rl-id='" + responsable_id +"']").hide()
      $(".formulaire-rl[data-rl-id='" + responsable_id +"']").show()
      $("#lien_de_parente_" + numero_responsable + "").focus()
    }

    $('#dossier_eleve_resp_legal_code_postal').on('input', function() {
      let inputValue = $(this).val();
      if (inputValue.length === 5) {
        $.ajax({
          method: "GET",
          url: '/api/communes/deduire_commune',
          data: { code_postal: inputValue, authenticity_token: "<%= form_authenticity_token %>" },
          success : function(response) {
            let $champ_input = $('#dossier_eleve_resp_legal_ville')
            $champ_input.empty()
            $.each(response, function (key, value) {
              $champ_input.append($("<option></option>")
                .attr("value", value).text(value))
            })
          }
        })
      }
    })
  })
</script>
