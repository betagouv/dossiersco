<% @section = 4 %>
<% nb_documents_demandes = dossier_eleve.etablissement.piece_attendue.size %>

<%= erb :'partials/navigation' %>

<div class="col-12">

  <h2 class="separation">Pièces à joindre</h2>

  <p>A scanner ou prendre en photo sur votre téléphone portable.</p>
  <div class="card-deck row">
    <% dossier_eleve.etablissement.piece_attendue.each do |piece| %>
      <form class="col-6 forms" action="/enregistre_piece_jointe" method="POST" enctype="multipart/form-data">
        <% piece_jointe = PieceJointe.find_by(
          piece_attendue_id: piece.id,
          dossier_eleve_id: dossier_eleve.id) %>
          <% document_stocke_url = piece_jointe.present? ? piece_jointe.clef : '' %>
        <div class="card <%= piece_jointe.etat if piece_jointe.present? %>">
          <h5 class="card-header"><%= piece.nom %></h5>
          <div class="card-body">
            <p class="card-text"><%= piece.explication %></p>
            <div class="card-relat document">

                <input data-btnClass="btn btn-primary" data-text="Parcourir" class='filestyle' type="file" name="<%= piece.code %>" id="<%= @variable %>"
                      multiple>
              <span id="fichier_<%= piece.code %>"></span>
              <br />
              <div class="image-piece-a-joindre lien-piece-jointe" id="image_<%= piece.code %>"
                    <% if document_stocke_url.present?
                        eleve_identifiant = dossier_eleve.nil? ? '' : dossier_eleve.eleve.identifiant
                        document_route = FichierUploader::route_lecture(eleve_identifiant, piece.code)+"/"+document_stocke_url
                        image_url = document_stocke_url.ends_with?('.pdf') ? "/images/reglement_dp_small.png" : document_route
                      %>
                      style="background-image: url('<%= image_url %>'); height: 200px; max-width: 350px;"
                      data-toggle="modal"
                      data-target="#modal-pieces-jointes"
                      data-url="<%= document_route %>"
                    <% end %>>
              </div>
            </div>
            <p><%= "Fichier #{piece_jointe.etat}" if piece_jointe.present? %></p>
          </div>
          <button class="soumettre d-none" type="submit">Soumettre</button>
        </div>

      </form>
    <% end %>
  </div>
  <div class="row mt-5">
    <div class="col-10 col-sm-6 col-md-4 mx-auto order-sm-2 mb-3">
        <a href='/validation' class="btn btn-primary float-right w-100">Enregistrer et continuer 
        <img src="/images/suivant.png" alt="suivant" title="suivant"></a>
    </div>
    <div class="col-10 col-sm-3 col-md-2 mx-auto order-sm-1">
        <a class="btn btn-primary w-100" href="/administration">
        <img src="/images/precedent.png" alt="précédent" title="précédent"> Retour</a>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<%= erb :'partials/image_box' %>
<script type="text/javascript" src="/js/bootstrap-filestyle-2.1.0/src/bootstrap-filestyle.min.js"> </script>
<script>
  $(document).ready(function() {
    $('input[type=file]')[0].focus();

    $('.forms').change(function() {
      console.log($(this).find( "input[type=file]" ).prop('files'))
      var data = $(this).serialize()
      $(this).find( ".soumettre" ).click()
    })
  });
</script>
