<div class="col-12 col-10">

  <span style="display:block; height: 50px;"></span>

  <div class="container">
    <div class="row">
      <div class="col-2">
      </div>
      <div class="col">
        <h1 class="separation">Eleves en cours de traitement</h1>
      </div>
    </div>
  </div>

  <span style="display:block; height: 20px;"></span>

  <table class="table table-striped table-bordered table-condensed table-hover"
  id="table_liste_des_eleves">
    <thead><tr>
      <th>Classe</th>
      <th>Prénom</th>
      <th>Nom</th>
      <th>Etat</th>
      <th>Photo</th>
      <th>Assurance</th>
      <th>Garde</th>
    </tr></thead>
    <tbody>
      <% dossier_eleves.each do |dossier_eleve| %>
        <% cliquable = "class='clickable-row' data-href='/agent/eleve/#{dossier_eleve.eleve.identifiant}'" %>
        <tr id="<%= dossier_eleve.id %>" style='cursor:pointer'>
          <th <%= cliquable %> ><%= dossier_eleve.eleve.classe_ant %></th>
          <th <%= cliquable %> ><%= dossier_eleve.eleve.prenom %></th>
          <th <%= cliquable %> ><%= dossier_eleve.eleve.nom %></th>
          <th <%= cliquable %> ><%= dossier_eleve.etat %></th>
          <th class="text-center" data-nom-fichier="etat_photo_identite">
            <% if dossier_eleve.photo_identite.present? %>
              <a class="lien-piece-jointe" data-toggle="modal" data-target="#modal-pieces-jointes" data-url="<%= dossier_eleve.photo_identite %>">
                <i class="fas fa-file-image"></i>
              </a>
              <i class="fas fa-check-circle etat" style="<%= 'color: #00cf00' if dossier_eleve.etat_photo_identite == 'valide' %>"></i>
              <i class="fas fa-times-circle etat" style="<%= 'color: red' if dossier_eleve.etat_photo_identite == 'invalide' %>"></i>
            <% end %>
          </th>
          <th class="text-center" data-nom-fichier="etat_assurance_scolaire">
            <% if dossier_eleve.assurance_scolaire.present? %>
              <a class="lien-piece-jointe" data-toggle="modal" data-target="#modal-pieces-jointes" data-url="<%= dossier_eleve.assurance_scolaire %>">
                <i class="fas fa-file-image"></i>
              </a>
              <i class="fas fa-check-circle etat" style="<%= 'color: #00cf00' if dossier_eleve.etat_assurance_scolaire == 'valide' %>"></i>
              <i class="fas fa-times-circle etat" style="<%= 'color: red' if dossier_eleve.etat_assurance_scolaire == 'invalide' %>"></i>
            <% end %>
          </th>
          <th class="text-center" data-nom-fichier="etat_jugement_garde_enfant">
            <% if dossier_eleve.jugement_garde_enfant.present? %>
              <a class="lien-piece-jointe"  data-toggle="modal" data-target="#modal-pieces-jointes" data-url="<%= dossier_eleve.jugement_garde_enfant %>">
                <i class="fas fa-file-image"></i>
              </a>
              <i class="fas fa-check-circle etat" style="<%= 'color: #00cf00' if dossier_eleve.etat_assurance_scolaire == 'valide' %>"></i>
              <i class="fas fa-times-circle etat" style="<%= 'color: red' if dossier_eleve.etat_assurance_scolaire == 'invalide' %>"></i>
            <% end %>
          </th>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="modal-pieces-jointes" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="titre-modal-pj"></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <iframe id="iframe-piece-jointe" src="" allowfullscreen></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf-8">
  $('.lien-piece-jointe').click(function() {
      var url = $(this).data('url');
      $('#iframe-piece-jointe').attr('src', url);
  });

  $('.etat').click(function() {
      var id = $(this).parent().parent().attr('id');
      var nom_fichier = $(this).parent().data('nom-fichier');
      if ($(this).hasClass('fa-check-circle')) {
          var etat = 'valide';
          $(this).css('color', '#00cf00');
          $(this).parent().find('.fa-times-circle').css('color', '#383f45');
      } else {
          var etat = 'invalide';
          $(this).css('color', 'red');
          $(this).parent().find('.fa-check-circle').css('color', '#383f45');
      }
    $.ajax({
        method: "POST",
        url: "/agent/change_etat_fichier",
        data: { id: id, nom_fichier: nom_fichier, etat: etat}
    })
  })
  jQuery(document).ready(function($) {
    $(".clickable-row").click(function() {
        window.location = $(this).data("href");
    });
    $('#table_liste_des_eleves').DataTable({
      "order": [[ 0, "desc" ]],
      language: {
        processing:     "Traitement en cours...",
        search:         "Rechercher&nbsp;:",
        lengthMenu:    "Afficher _MENU_ &eacute;l&egrave;ves",
        info:           "Affichage des &eacute;l&egrave;ves _START_ &agrave; _END_ sur _TOTAL_ &eacute;l&egrave;ves",
        infoEmpty:      "Affichage de l'&eacute;lement 0 &agrave; 0 sur 0 &eacute;l&egrave;ves",
        infoFiltered:   "(filtr&eacute; de _MAX_ &eacute;l&egrave;ves au total)",
        infoPostFix:    "",
        loadingRecords: "Chargement en cours...",
        zeroRecords:    "Aucun &eacute;l&egrave;ve &agrave; afficher",
        emptyTable:     "Aucune donnée disponible dans le tableau",
        paginate: {
            first:      "Premier",
            previous:   "Pr&eacute;c&eacute;dent",
            next:       "Suivant",
            last:       "Dernier"
        },
        aria: {
            sortAscending:  ": activer pour trier la colonne par ordre croissant",
            sortDescending: ": activer pour trier la colonne par ordre décroissant"
        }
    }
  });
});

</script>
